/* 
 * CraftMap
 * author: Marcin Dziewulski
 * web: http://www.jscraft.net
 * email: info@jscraft.net
 * license: http://www.jscraft.net/licensing.html
 */
(function(f){f.fn.craftmap=function(r){var g={cookies:!1,fullscreen:!1,container:{name:"imgContent"},image:{width:1475,height:1200,name:"imgMap"},map:{position:"center"},marker:{name:"marker",center:!0,popup:!0,popup_name:"popup",onClick:function(){},onClose:function(){}},controls:{init:!0,name:"controls",onClick:function(){}},preloader:{init:!0,name:"preloader",onLoad:function(){}}},d=f.extend(!0,g,r);return this.each(function(){var e=f(this),q=e.find("."+d.image.name),c={init:function(){this._container.init(); d.fullscreen&&(this.fullscreen.init(),this.fullscreen.resize());this._globals.init();d.preloader.init&&this.preloader.init();this.map.init();this.marker.init();d.controls.init&&this.controls.init()},_container:{init:function(){c._container.css();c._container.wrap()},css:function(){q.css({width:"100%",height:"100%"});e.css({position:"relative",overflow:"hidden",cursor:"move"})},wrap:function(){var a={zIndex:"1",position:"absolute",width:d.image.width,height:d.image.height};e.wrapInner(f("<div />").addClass(d.container.name).css(a))}}, _globals:{init:function(){C=e.find("."+d.container.name);MARKER=C.find("."+d.marker.name);md=!1;mx=0;my=0;ex=0;ey=0;delta=0;mv=[];interval=0;g={w:e.width(),h:e.height()};I={w:C.width(),h:C.height()};d.controls.init&&(CONTROLS=f("."+d.controls.name).find("a"))}},_mouse:{get:function(a){return{x:a.pageX,y:a.pageY}},update:function(a){a=c._mouse.get(a);a=c.map.position.check(ex+(a.x-mx),ey+(a.y-my));C.css({top:a.y,left:a.x});d.cookies&&c.cookies.create("position",a.x+","+a.y,7)},decelerate:function(){var a= mv.length,b=0;a&&(interval=setInterval(function(){var d=C.position(),l=(20-b)/20,f=a-1,d=c.map.position.check((mv[f].x-mv[0].x)/a*l+d.left,(mv[f].y-mv[0].y)/a*l+d.top);C.css({left:d.x,top:d.y});++b;20==b&&(clearInterval(interval),b=0)},40))},wheel:{init:function(){e.handle=function(a){a.preventDefault();if(!a)a=window.event;a.wheelDelta?(delta=a.wheelDelta/120,window.opera&&(delta=-delta)):a.detail&&(delta=-a.detail/3)};window.addEventListener&&window.addEventListener("DOMMouseScroll",e.handle,!1); window.onmousewheel=document.onmousewheel=e.handle},remove:function(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",e.handle,!1);window.onmousewheel=document.onmousewheel=null}}},fullscreen:{init:function(){var a=f(window),b=a.width(),a=a.height();e.css({width:b,height:a})},resize:function(){f(window).resize(function(){c.fullscreen.init();g={w:e.width(),h:e.height()}})}},cookies:{create:function(a,b,d){if(d){var c=new Date,d=c.getTime()+864E5*d;c.setTime(d);c="; expires="+ c.toGMTString()}else c="";document.cookie=a+"="+b+c+"; path=/"},erase:function(a){cookies.create(a,"",-1)},read:function(a){for(var a=a+"=",b=document.cookie.split(";"),d=0;d<b.length;d++){for(var c=b[d];" "==c.charAt(0);)c=c.substring(1,c.length);if(0==c.indexOf(a))return c.substring(a.length,c.length)}return null}},preloader:{init:function(){var a=new Image,b=q.attr("src");c.preloader.create();f(a).addClass(d.image.name).attr("src",b).load(function(){var a=f(this),b={width:this.width,height:this.height}; a.css(b);q.remove();c.preloader.remove();d.preloader.onLoad.call(this,a,b)}).appendTo(C)},create:function(){e.append(f("<div />").addClass(d.preloader.name).css({position:"absolute",zIndex:"10",top:"0",left:"0",width:"100%",height:"100%"}))},remove:function(){e.find("."+d.preloader.name).fadeOut(400,function(){f(this).remove()})}},map:{init:function(){c.map.position.set();c.map.move()},position:{set:function(){if(d.cookies)if("null"!=typeof c.cookies.read("position"))var a=c.cookies.read("position").split(","), b=a[0],a=a[1];else b=(g.w-I.w)/2,a=(g.h-I.h)/2;else switch(a=d.map.position,a){case "center":b=(g.w-I.w)/2;a=(g.h-I.h)/2;break;case "top_left":a=b=0;break;case "top_right":b=g.w-I.w;a=0;break;case "bottom_left":b=0;a=g.h-I.h;break;case "bottom_right":b=g.w-I.w;a=g.h-I.h;break;default:a=a.split(" "),b=-a[0],a=-a[1],a=c.map.position.check(b,a),b=a.x,a=a.y}C.css({top:a,left:b})},check:function(a,b){b<g.h-I.h?b=g.h-I.h:0<b&&(b=0);a<g.w-I.w?a=g.w-I.w:0<a&&(a=0);return{x:a,y:b}}},move:function(){C.bind({mousedown:function(a){md= !0;var b=c._mouse.get(a);mx=b.x;my=b.y;b=C.position();ex=b.left;ey=b.top;mv=[];clearInterval(interval);c._mouse.update(a);return!1},mousemove:function(a){md&&(c._mouse.update(a),a=c._mouse.get(a),mv.push({x:a.x,y:a.y}),15<mv.length&&mv.pop());return!1},mouseup:function(a){md&&(md=!1);c._mouse.decelerate(a);return!1},mouseout:function(){md&&(md=!1);c._mouse.wheel.remove();return!1},mouseover:function(a){c._mouse.wheel.init(a);return!1},mousewheel:function(a){c._zoom.init(a)}})}},_zoom:{init:function(){}}, marker:{init:function(){c.marker.set();c.marker.open();c.marker.close()},set:function(){MARKER.each(function(){var a=f(this),b=a.attr("data-coords").split(",");x=parseInt(b[0]);y=parseInt(b[1]);css={position:"absolute",zIndex:"2",top:y,left:x};a.css(css)}).wrapInner(f("<div />").addClass(d.marker.name+"Content").hide())},open:function(){MARKER.live("click",function(){var a=f(this),b=a.attr("id"),e=d.marker,l=a.width(),m=a.height(),b=a.position(),i=b.left,j=b.top,b=a.attr("id"),k=a.find("."+e.name+ "Content").html();if(e.center){var h=c.map.position.check(-i+g.w/2-l/2,-j+g.h/2-m/2);C.animate({top:h.y,left:h.x})}if(e.popup){f("."+e.popup_name).remove();h={position:"absolute",zIndex:"3"};a.after(f("<div />").addClass(e.popup_name+" "+b).css(h).html(k).append(f("<a />").addClass("close")));var p=a.next("."+e.popup_name),k=p.innerWidth(),h=p.innerHeight(),n=0,o=0,n=0>i-k?i:i+k/2>I.w?i-k+l:i-(k/2-l/2),o=0>j-h?j+m+m/1.5:j-h-m/1.5;0>i-k&&0>j-h?(n=i+2*l,o=j-m/2):0>j-h&&i+k/2>I.w?(n=i-k-l/2,o=j-m/2): j+h>I.h&&i+k/2>I.w?(n=i-k+l,o=j-h-m/2):j+h>I.h&&0>i-k&&(n=i,o=j-h-m/2);h={left:n,top:o};p.css(h)}c.controls.active.set(b);e.onClick.call(this,a,p);return!1})},close:function(){C.find(".close").live("click",function(){var a=f(this).parents("."+d.marker.popup_name),b=a.prev("."+d.marker.name);a.remove();c.controls.active.remove();d.marker.onClose.call(this,b,a);return!1})}},controls:{init:function(){c.controls.set()},set:function(){CONTROLS.click(function(){var a=f(this).attr("rel");div=C.find("."+ d.marker.name).filter("#"+a);div.trigger("click");d.controls.onClick.call(this,div);return!1})},active:{set:function(a){d.controls.init&&CONTROLS.removeClass("active").filter(function(){return this.rel==a}).addClass("active")},remove:function(){d.controls.init&&CONTROLS.removeClass("active")}}}};c.init()})}})(jQuery);